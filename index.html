<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZaapFlow - Construtor de Funil</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca para as linhas de conexão -->
    <script src="https://cdn.jsdelivr.net/npm/leader-line-new@1.1.9/leader-line.min.js"></script>

    <style>
        :root {
            --bg-main: #111111; --bg-secondary: #1C1C1C; --bg-tertiary: #2A2A2A;
            --text-primary: #EAEAEA; --text-secondary: #A0A0A0; --border-color: #363636;
            --accent-yellow: #FFD23F; --accent-yellow-dark: #F8B700;
            --accent-yellow-glow: rgba(255, 210, 63, 0.5); --shadow-color: rgba(0, 0, 0, 0.5);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); }
        
        #flow-canvas {
            background-color: var(--bg-main);
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #flow-canvas.drag-over { background-color: rgba(255, 210, 63, 0.05); }
        #flow-canvas:active { cursor: grabbing; }
        
        .neon-yellow-text { color: var(--accent-yellow); text-shadow: 0 0 5px var(--accent-yellow-glow), 0 0 10px var(--accent-yellow-glow); }
        .neon-yellow-bar { background-color: var(--accent-yellow); box-shadow: 0 0 8px var(--accent-yellow-glow); }
        
        .draggable {
            display: flex; align-items: center; padding: 0.75rem;
            border-radius: 0.375rem; background-color: var(--bg-tertiary);
            cursor: move; transition: background-color 0.2s;
        }
        .draggable:hover { background-color: #3a3a3a; }
        .draggable i { width: 2rem; text-align: center; }
        .draggable span { margin-left: 0.75rem; font-size: 0.875rem; font-weight: 500; }
        
        .canvas-component {
            position: absolute; cursor: grab; z-index: 10; width: 280px;
            background-color: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 8px; box-shadow: 0 10px 20px var(--shadow-color);
        }
        .component-header {
            background-color: var(--bg-tertiary); border-top-left-radius: 7px;
            border-top-right-radius: 7px; border-bottom: 1px solid var(--border-color);
        }
        .component-header .accent-bar { height: 3px; width: 100%; border-top-left-radius: 7px; border-top-right-radius: 7px; }

        .connector-point {
            position: absolute; top: 50%; width: 16px; height: 16px;
            background-color: var(--bg-tertiary); border: 2px solid var(--text-secondary);
            border-radius: 50%; cursor: crosshair; z-index: 11; transition: all 0.2s ease;
        }
        .connector-point:hover { border-color: var(--accent-yellow); transform: translateY(-50%) scale(1.2); }
        .connector-point.input { left: -8px; transform: translateY(-50%); }
        .connector-point.output { right: -8px; transform: translateY(-50%); }
        .multi-output-container .connector-point.output { position: relative; right: 0; top: 0; transform: none; }

        .leader-line { z-index: 5; }
        .component-controls { display: none; }
        .canvas-component:hover .component-controls { display: flex; }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); z-index: 40; display: flex;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--bg-secondary); padding: 24px; border-radius: 8px;
            border: 1px solid var(--border-color); width: 90%; max-width: 500px;
        }

        input[type="text"], input[type="number"], textarea {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        input[type="color"] {
             -webkit-appearance: none; border: none; width: 100%; height: 40px;
             padding: 0; background-color: transparent;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border-radius: 6px; border: 1px solid var(--border-color); }

        .btn-action-yellow {
            background-color: var(--accent-yellow); color: #111;
            font-weight: 600; transition: background-color 0.2s ease;
        }
        .btn-action-yellow:hover { background-color: var(--accent-yellow-dark); }

        #preview-chat-container {
            background-color: #e5ddd5;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }
        #preview-chat-body::-webkit-scrollbar { width: 6px; }
        #preview-chat-body::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 3px; }
        
        /* Estilos para o player de áudio customizado */
        .audio-player-container {
            align-self: flex-start; max-width: 80%; background-color: #fff;
            padding: 8px; border-radius: 10px; border-top-left-radius: 0;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1); color: #333;
            display: flex; align-items: center; gap: 8px;
        }
        .audio-player-container img { width: 40px; height: 40px; border-radius: 50%; }
        .audio-player-container .play-pause-btn {
            background: none; border: none; font-size: 1.5rem; color: #555; cursor: pointer;
        }
        .audio-player-container .progress-bar-container {
            flex-grow: 1; height: 4px; background-color: #ccc; border-radius: 2px;
            position: relative; cursor: pointer;
        }
        .audio-player-container .progress-bar {
            height: 100%; background-color: #666; border-radius: 2px;
            width: 0; position: relative;
        }
        .audio-player-container .progress-bar::after {
            content: ''; position: absolute; right: -6px; top: -4px;
            width: 12px; height: 12px; border-radius: 50%; background-color: #666;
        }
        .audio-player-container .time-info {
            display: flex; flex-direction: column; align-items: flex-end;
            font-size: 0.7em; color: #999;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-secondary shadow-md px-4 md:px-6 py-3 flex justify-between items-center z-30 border-b border-border-color">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-bolt text-2xl neon-yellow-text"></i>
            <h1 class="text-lg md:text-xl font-bold text-primary">ZaapFlow</h1>
        </div>
        <div class="hidden md:block text-lg font-semibold">Construtor de Funil</div>
        <div></div>
    </header>

    <div class="flex-grow grid grid-cols-12 overflow-hidden">
        <aside class="col-span-12 md:col-span-3 bg-secondary p-4 overflow-y-auto border-r border-border-color">
            <div class="mb-6">
                <h3 class="font-semibold text-text-secondary mb-3">CONFIGURAÇÕES</h3>
                <div class="space-y-3">
                    <div>
                        <label for="chat-name-input" class="text-sm text-text-secondary">Nome do Chat</label>
                        <input type="text" id="chat-name-input" value="TOP FLIX" class="w-full mt-1 p-2 rounded-md text-sm">
                    </div>
                    <div>
                        <label for="chat-photo-input" class="text-sm text-text-secondary">URL da Foto de Perfil</label>
                        <input type="text" id="chat-photo-input" value="https://i.ibb.co/zTTD7BJf/Ezbc8zz-X0-AQ5-F7p.png" class="w-full mt-1 p-2 rounded-md text-sm">
                    </div>
                    <button id="save-settings-btn" class="w-full p-2 rounded-md text-sm btn-action-yellow">Salvar Configurações</button>
                </div>
            </div>
            <hr class="border-border-color my-6">
            <div class="mb-6">
                <h3 class="font-semibold text-text-secondary mb-3">MENSAGENS</h3>
                <div class="space-y-2">
                    <div class="draggable" draggable="true" data-component-type="received-message"><i class="fas fa-comment-dots neon-yellow-text"></i><span>Mensagem Recebida</span></div>
                    <div class="draggable" draggable="true" data-component-type="sent-message"><i class="fas fa-paper-plane neon-yellow-text"></i><span>Mensagem Enviada</span></div>
                    <div class="draggable" draggable="true" data-component-type="image-message"><i class="fas fa-image neon-yellow-text"></i><span>Imagem</span></div>
                    <div class="draggable" draggable="true" data-component-type="audio-message"><i class="fas fa-file-audio neon-yellow-text"></i><span>Áudio</span></div>
                    <div class="draggable" draggable="true" data-component-type="video-message"><i class="fab fa-youtube neon-yellow-text"></i><span>Vídeo do YouTube</span></div>
                </div>
            </div>
            <div>
                <h3 class="font-semibold text-text-secondary mb-3">LÓGICA E AÇÕES</h3>
                <div class="space-y-2">
                     <div class="draggable" draggable="true" data-component-type="ask-question"><i class="fas fa-question-circle neon-yellow-text"></i><span>Pergunta com Botões</span></div>
                     <div class="draggable" draggable="true" data-component-type="user-input"><i class="fas fa-keyboard neon-yellow-text"></i><span>Campo de Resposta</span></div>
                     <div class="draggable" draggable="true" data-component-type="cta-button"><i class="fas fa-mouse-pointer neon-yellow-text"></i><span>Botão (CTA)</span></div>
                     <div class="draggable" draggable="true" data-component-type="delay"><i class="fas fa-clock neon-yellow-text"></i><span>Esperar (Delay)</span></div>
                </div>
            </div>
        </aside>

        <main class="col-span-12 md:col-span-9 lg:col-span-5 relative border-r border-border-color overflow-hidden">
            <div id="flow-canvas" class="w-full h-full">
                <div id="flow-transformer" class="w-full h-full" style="transform-origin: 0 0;"></div>
            </div>
            <div class="absolute bottom-4 right-4 flex flex-col gap-2 z-20">
                <button id="zoom-in-btn" class="w-10 h-10 bg-tertiary rounded-md flex items-center justify-center text-lg"><i class="fas fa-plus"></i></button>
                <button id="zoom-out-btn" class="w-10 h-10 bg-tertiary rounded-md flex items-center justify-center text-lg"><i class="fas fa-minus"></i></button>
                <button id="reset-view-btn" class="w-10 h-10 bg-tertiary rounded-md flex items-center justify-center text-lg"><i class="fas fa-expand"></i></button>
            </div>
        </main>

        <aside class="hidden lg:flex col-span-4 bg-secondary p-4 flex-col">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-lg font-bold text-primary border-b border-transparent pb-2">Prévia ao Vivo</h2>
                 <button id="test-flow-btn" class="px-3 py-1 rounded-md text-sm flex items-center gap-2 btn-action-yellow"><i class="fas fa-play"></i> Testar Fluxo</button>
            </div>
            <div id="preview-container" class="flex-grow bg-main rounded-lg p-2">
                 <div id="preview-chat-container" class="w-full h-full max-w-md mx-auto rounded-xl shadow-inner overflow-hidden flex flex-col"></div>
            </div>
        </aside>
    </div>

    <div id="edit-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Editar Componente</h3>
            <div id="modal-body"></div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-cancel" class="px-4 py-2 rounded-md bg-tertiary hover:bg-opacity-70">Cancelar</button>
                <button id="modal-save" class="px-4 py-2 rounded-md btn-action-yellow">Salvar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const flowCanvas = document.getElementById('flow-canvas');
        const transformer = document.getElementById('flow-transformer');
        const modal = document.getElementById('edit-modal');
        
        let connections = [];
        let currentDrawingLine = null;
        let startElementForLine = null;
        let elementToEdit = null;

        let panX = 0, panY = 0, zoom = 1;
        let isPanning = false;
        let panStartX, panStartY;

        let chatName = 'TOP FLIX';
        let profilePicUrl = 'https://i.ibb.co/zTTD7BJf/Ezbc8zz-X0-AQ5-F7p.png';

        const componentInfoMap = {
            'received-message': { name: 'Mensagem Recebida', icon: 'fa-comment-dots', text: 'Olá! Escreva sua mensagem aqui.' },
            'sent-message': { name: 'Mensagem Enviada', icon: 'fa-paper-plane', text: 'Esta é a minha resposta.' },
            'ask-question': { name: 'Pergunta com Botões', icon: 'fa-question-circle', text: 'Qual é a sua pergunta?', buttons: 'Sim;Não' },
            'delay': { name: 'Esperar (Delay)', icon: 'fa-clock', delay: 2 },
            'image-message': { name: 'Imagem', icon: 'fa-image', url: 'https://placehold.co/600x400/2A2A2A/EAEAEA?text=Imagem' },
            'audio-message': { name: 'Áudio', icon: 'fa-file-audio', url: '' },
            'video-message': { name: 'Vídeo do YouTube', icon: 'fab fa-youtube', url: '' },
            'cta-button': { name: 'Botão (CTA)', icon: 'fa-mouse-pointer', text: 'Clique Aqui', url: '#', color: '#FFD23F', neon: 'true' },
            'user-input': { name: 'Campo de Resposta', icon: 'fa-keyboard', placeholder: 'Digite sua resposta...' },
        };

        const applyTransform = () => {
            transformer.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
            connections.forEach(c => c.line.position());
        };

        flowCanvas.addEventListener('wheel', e => {
            e.preventDefault();
            const zoomSpeed = 0.1;
            const oldZoom = zoom;
            zoom -= e.deltaY > 0 ? zoomSpeed : -zoomSpeed;
            zoom = Math.max(0.2, Math.min(2, zoom));
            const rect = flowCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            panX = mouseX - (mouseX - panX) * (zoom / oldZoom);
            panY = mouseY - (mouseY - panY) * (zoom / oldZoom);
            applyTransform();
        });

        flowCanvas.addEventListener('mousedown', e => {
            if (e.button === 1 || (e.button === 0 && e.target === flowCanvas)) { 
                isPanning = true;
                panStartX = e.clientX - panX;
                panStartY = e.clientY - panY;
                flowCanvas.style.cursor = 'grabbing';
            }
        });
        window.addEventListener('mousemove', e => { if (isPanning) { panX = e.clientX - panStartX; panY = e.clientY - panStartY; applyTransform(); } });
        window.addEventListener('mouseup', () => { isPanning = false; flowCanvas.style.cursor = 'default'; });

        document.getElementById('zoom-in-btn').onclick = () => { zoom = Math.min(2, zoom + 0.1); applyTransform(); };
        document.getElementById('zoom-out-btn').onclick = () => { zoom = Math.max(0.2, zoom - 0.1); applyTransform(); };
        document.getElementById('reset-view-btn').onclick = () => { panX = 0; panY = 0; zoom = 1; applyTransform(); };

        document.querySelectorAll('.draggable').forEach(draggable => {
            draggable.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text/plain', e.target.dataset.componentType);
                e.dataTransfer.setData('isNew', 'true');
            });
        });
        flowCanvas.addEventListener('dragover', e => { e.preventDefault(); flowCanvas.classList.add('drag-over'); });
        flowCanvas.addEventListener('dragleave', () => flowCanvas.classList.remove('drag-over'));
        flowCanvas.addEventListener('drop', e => {
            e.preventDefault();
            flowCanvas.classList.remove('drag-over');
            if (e.dataTransfer.getData('isNew') === 'true') {
                const rect = flowCanvas.getBoundingClientRect();
                const x = (e.clientX - rect.left - panX) / zoom;
                const y = (e.clientY - rect.top - panY) / zoom;
                createFlowComponent(e.dataTransfer.getData('text/plain'), x, y);
            }
        });

        function createFlowComponent(type, x, y) {
            const id = `component_${Date.now()}`;
            const wrapper = document.createElement('div');
            wrapper.id = id;
            wrapper.className = 'canvas-component';
            wrapper.style.left = `${x}px`;
            wrapper.style.top = `${y}px`;
            wrapper.dataset.componentType = type;

            const info = componentInfoMap[type];
            Object.keys(info).forEach(key => {
                if(key !== 'name' && key !== 'icon') wrapper.dataset[key] = info[key];
            });

            let contentHTML = '';
            if (type === 'ask-question') {
                const buttons = info.buttons.split(';');
                contentHTML += `<div class="p-3"><p class="component-text text-sm text-text-secondary truncate">${info.text}</p></div>`;
                contentHTML += `<div class="multi-output-container border-t border-border-color divide-y divide-border-color">`;
                buttons.forEach((btn, index) => {
                    contentHTML += `<div class="flex justify-between items-center p-2 text-sm text-text-secondary">
                                        <span class="truncate">${btn}</span>
                                        <div class="connector-point output" data-output-index="${index}"></div>
                                    </div>`;
                });
                contentHTML += `</div>`;
            } else {
                 let displayText = info.text || `Aguardar por ${info.delay} segundos`;
                 if (['image-message', 'audio-message', 'video-message'].includes(type)) displayText = `URL: ${info.url || 'Não definida'}`;
                 if (type === 'cta-button') displayText = `Botão: ${info.text}`;
                 if (type === 'user-input') displayText = `Placeholder: ${info.placeholder}`;
                 contentHTML = `<div class="p-3"><p class="component-text text-sm text-text-secondary truncate">${displayText}</p></div>`;
            }

            wrapper.innerHTML = `
                <div class="component-header">
                    <div class="accent-bar neon-yellow-bar"></div>
                    <div class="flex justify-between items-center p-2">
                        <p class="text-sm font-semibold flex items-center"><i class="fas ${info.icon} mr-2 neon-yellow-text"></i> ${info.name}</p>
                        <div class="component-controls gap-2">
                            <button class="control-btn edit text-xs" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                            <button class="control-btn remove text-xs" title="Remover"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
                ${contentHTML}
                <div class="connector-point input"></div>
                ${type !== 'ask-question' ? '<div class="connector-point output"></div>' : ''}
            `;
            transformer.appendChild(wrapper);
            makeDraggable(wrapper);
            setupControls(wrapper);
            updatePreview();
        }

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.onmousedown = e => {
                if (e.target.closest('.connector-point, .component-controls')) return;
                e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
            };
            function elementDrag(e) {
                e.preventDefault();
                pos1 = (pos3 - e.clientX) / zoom;
                pos2 = (pos4 - e.clientY) / zoom;
                pos3 = e.clientX; pos4 = e.clientY;
                element.style.top = `${element.offsetTop - pos2}px`;
                element.style.left = `${element.offsetLeft - pos1}px`;
                updateConnectionsForElement(element);
            }
            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
        }
        
        function setupControls(element) {
            element.querySelector('.remove').onclick = () => {
                removeConnectionsForElement(element);
                element.remove();
                updatePreview();
            };
            element.querySelector('.edit').onclick = () => openEditModal(element);
        }

        flowCanvas.addEventListener('mousedown', e => {
            if (e.target.classList.contains('output')) {
                startElementForLine = e.target;
                currentDrawingLine = new LeaderLine(e.target, LeaderLine.pointAnchor(document.body, { x: e.clientX, y: e.clientY }), {
                    color: 'rgba(255, 210, 63, 0.7)', size: 2, endPlug: 'behind'
                });
            }
        });

        document.addEventListener('mousemove', e => { 
            if (currentDrawingLine) {
                currentDrawingLine.position();
                currentDrawingLine.setOptions({ end: LeaderLine.pointAnchor(document.body, { x: e.clientX, y: e.clientY }) });
            }
        });
        
        document.addEventListener('mouseup', e => {
            if (currentDrawingLine) {
                currentDrawingLine.hide();
                const endElement = e.target.closest('.canvas-component');
                currentDrawingLine.remove();
                currentDrawingLine = null;
                
                if (endElement && endElement !== startElementForLine.closest('.canvas-component')) {
                    const line = new LeaderLine(startElementForLine, endElement.querySelector('.input'), {
                        color: 'var(--accent-yellow)', size: 2, path: 'fluid',
                        startSocketGravity: 60, endSocketGravity: 60,
                        dropShadow: { color: 'var(--accent-yellow-glow)', dx: 0, dy: 0, blur: 6 },
                        endPlug: 'behind'
                    });
                    connections.push({ line, start: startElementForLine.closest('.canvas-component'), end: endElement });
                }
                startElementForLine = null;
            }
        });

        function updateConnectionsForElement(element) { connections.forEach(conn => { if (conn.start === element || conn.end === element) conn.line.position(); }); }
        
        function removeConnectionsForElement(element) {
            const remaining = [];
            connections.forEach(conn => {
                if (conn.start === element || conn.end === element) conn.line.remove();
                else remaining.push(conn);
            });
            connections = remaining;
        }

        function updatePreview(chatBody) {
            if (!chatBody) {
                const previewChatContainer = document.getElementById('preview-chat-container');
                if (!previewChatContainer) return;
                previewChatContainer.innerHTML = `
                    <div style="background-color: #075E54; color: white; padding: 10px 15px; display: flex; align-items: center; gap: 15px; flex-shrink: 0;">
                        <img src="${profilePicUrl}" alt="Foto" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; object-fit: cover;" onerror="this.src='https://placehold.co/45x45/075E54/FFFFFF?text=??'">
                        <div><div style="font-weight: bold;">${chatName}</div><div style="font-size: 0.8em; color: #d1d1d1;">online</div></div>
                    </div>
                    <div id="preview-chat-body" style="flex-grow: 1; padding: 20px 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;"></div>
                `;
                chatBody = document.getElementById('preview-chat-body');
            }
            
            chatBody.innerHTML = '';
            transformer.querySelectorAll('.canvas-component').forEach(comp => {
                const previewElement = createPreviewComponent(comp);
                if (previewElement) chatBody.appendChild(previewElement);
            });
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        document.getElementById('save-settings-btn').onclick = () => {
            chatName = document.getElementById('chat-name-input').value;
            profilePicUrl = document.getElementById('chat-photo-input').value;
            updatePreview();
        };

        function openEditModal(element) {
            elementToEdit = element;
            const type = element.dataset.componentType;
            const modalBody = modal.querySelector('#modal-body');
            let formHTML = '';

            switch(type) {
                case 'received-message': case 'sent-message':
                    formHTML = `<label class="block text-sm font-medium text-text-secondary mb-2">Texto</label><textarea id="text-input" class="w-full p-2 rounded-md" rows="4">${element.dataset.text}</textarea>`;
                    break;
                case 'ask-question':
                    formHTML = `<label class="block text-sm font-medium text-text-secondary mb-2">Texto da Pergunta</label><textarea id="text-input" class="w-full p-2 rounded-md" rows="3">${element.dataset.text}</textarea>
                                <label class="block text-sm font-medium text-text-secondary mt-4 mb-2">Botões (um por linha)</label><textarea id="buttons-input" class="w-full p-2 rounded-md" rows="3">${element.dataset.buttons.split(';').join('\n')}</textarea>`;
                    break;
                case 'delay':
                    formHTML = `<label class="block text-sm font-medium text-text-secondary mb-2">Tempo de espera (segundos)</label><input type="number" id="delay-input" class="w-full p-2 rounded-md" value="${element.dataset.delay}">`;
                    break;
                case 'image-message': case 'audio-message': case 'video-message':
                    let label = type.includes('image') ? 'Imagem' : (type.includes('audio') ? 'Áudio' : 'Vídeo');
                    formHTML = `<label class="block text-sm font-medium text-text-secondary mb-2">URL do ${label}</label><input type="text" id="url-input" class="w-full p-2 rounded-md" value="${element.dataset.url}">`;
                    break;
                case 'cta-button':
                    formHTML = `<label class="block text-sm font-medium text-text-secondary mb-2">Texto do Botão</label><input type="text" id="text-input" class="w-full p-2 rounded-md" value="${element.dataset.text}">
                                <label class="block text-sm font-medium text-text-secondary mt-4 mb-2">URL do Link</label><input type="text" id="url-input" class="w-full p-2 rounded-md" value="${element.dataset.url}">
                                <label class="block text-sm font-medium text-text-secondary mt-4 mb-2">Cor do Botão</label><input type="color" id="color-input" class="w-full h-10" value="${element.dataset.color}">
                                <div class="flex items-center mt-4"><input type="checkbox" id="neon-input" class="h-4 w-4 rounded bg-tertiary border-border-color" ${element.dataset.neon === 'true' ? 'checked' : ''}><label for="neon-input" class="ml-2 text-sm text-text-secondary">Efeito Neon</label></div>`;
                    break;
                case 'user-input':
                    formHTML = `<label class="block text-sm font-medium text-text-secondary mb-2">Texto do Placeholder</label><input type="text" id="placeholder-input" class="w-full p-2 rounded-md" value="${element.dataset.placeholder}">`;
                    break;
            }
            modalBody.innerHTML = formHTML;
            modal.classList.remove('hidden');
        }

        modal.querySelector('#modal-save').onclick = () => {
            if (!elementToEdit) return;
            const type = elementToEdit.dataset.componentType;
            let displayText = '';

            switch(type) {
                case 'received-message': case 'sent-message':
                    elementToEdit.dataset.text = modal.querySelector('#text-input').value;
                    displayText = elementToEdit.dataset.text;
                    break;
                case 'ask-question':
                    elementToEdit.dataset.text = modal.querySelector('#text-input').value;
                    const buttons = modal.querySelector('#buttons-input').value.split('\n').filter(b => b);
                    elementToEdit.dataset.buttons = buttons.join(';');
                    displayText = elementToEdit.dataset.text;
                    let buttonOutputsHTML = '';
                    buttons.forEach((btn, index) => {
                        buttonOutputsHTML += `<div class="flex justify-between items-center p-2 text-sm text-text-secondary"><span class="truncate">${btn}</span><div class="connector-point output" data-output-index="${index}"></div></div>`;
                    });
                    elementToEdit.querySelector('.multi-output-container').innerHTML = buttonOutputsHTML;
                    break;
                case 'delay':
                    elementToEdit.dataset.delay = modal.querySelector('#delay-input').value;
                    displayText = `Aguardar por ${elementToEdit.dataset.delay} segundos`;
                    break;
                case 'image-message': case 'audio-message': case 'video-message':
                    elementToEdit.dataset.url = modal.querySelector('#url-input').value;
                    displayText = `URL: ${elementToEdit.dataset.url}`;
                    break;
                case 'cta-button':
                    elementToEdit.dataset.text = modal.querySelector('#text-input').value;
                    elementToEdit.dataset.url = modal.querySelector('#url-input').value;
                    elementToEdit.dataset.color = modal.querySelector('#color-input').value;
                    elementToEdit.dataset.neon = modal.querySelector('#neon-input').checked;
                    displayText = `Botão: ${elementToEdit.dataset.text}`;
                    break;
                case 'user-input':
                    elementToEdit.dataset.placeholder = modal.querySelector('#placeholder-input').value;
                    displayText = `Placeholder: ${elementToEdit.dataset.placeholder}`;
                    break;
            }
            if(elementToEdit.querySelector('.component-text')) elementToEdit.querySelector('.component-text').innerText = displayText;
            modal.classList.add('hidden');
            elementToEdit = null;
            updatePreview();
        };
        
        modal.querySelector('#modal-cancel').onclick = () => modal.classList.add('hidden');

        function createPreviewComponent(element) {
            const type = element.dataset.componentType;
            const time = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const wrapper = document.createElement('div');
            wrapper.style.cssText = "display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 12px;";

            switch(type) {
                case 'delay':
                case 'audio-message':
                    const isAudio = type === 'audio-message';
                    const animationName = isAudio ? 'mic-bounce' : 'bounce';
                    wrapper.innerHTML = `<div style="align-self: flex-start; display: flex; align-items: center; padding: 10px 15px;">
                        ${isAudio ? `<i class="fas fa-microphone text-xl text-red-500" style="animation: ${animationName} 1.3s infinite ease-in-out;"></i><span class="text-gray-500 text-sm ml-2"> gravando áudio...</span>` : `
                        <span style="height: 8px; width: 8px; background-color: #888; border-radius: 50%; display: inline-block; margin: 0 2px; animation: bounce 1.3s infinite ease-in-out;"></span>
                        <span style="height: 8px; width: 8px; background-color: #888; border-radius: 50%; display: inline-block; margin: 0 2px; animation: bounce 1.3s infinite ease-in-out -1.1s;"></span>
                        <span style="height: 8px; width: 8px; background-color: #888; border-radius: 50%; display: inline-block; margin: 0 2px; animation: bounce 1.3s infinite ease-in-out -0.9s;"></span>`}
                    </div><style>@keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } } @keyframes mic-bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }</style>`;
                    break;
                case 'video-message':
                    const videoId = element.dataset.url.split('v=')[1]?.split('&')[0] || element.dataset.url.split('/').pop();
                    wrapper.innerHTML = `<div style="align-self: flex-start; max-width: 80%; background-color: #fff; padding: 5px; border-radius: 10px; border-top-left-radius: 0; box-shadow: 0 1px 1px rgba(0,0,0,0.1);">
                        <iframe style="width: 100%; aspect-ratio: 16/9; border-radius: 8px;" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>
                    </div>`;
                    break;
                case 'cta-button':
                    const color = element.dataset.color;
                    const neon = element.dataset.neon === 'true' ? `box-shadow: 0 0 10px ${color}, 0 0 20px ${color}80;` : '';
                    wrapper.innerHTML = `<div style="padding: 10px;"><a href="${element.dataset.url}" target="_blank" style="padding: 12px 24px; background-color: ${color}; color: #111; font-weight: bold; border-radius: 30px; text-decoration: none; ${neon}">${element.dataset.text}</a></div>`;
                    wrapper.style.alignItems = 'center';
                    break;
                case 'user-input':
                    wrapper.innerHTML = `<div style="width: 100%; background-color: #f0f2f5; padding: 10px; display: flex; gap: 10px; margin-top: auto;">
                        <input type="text" placeholder="${element.dataset.placeholder}" style="flex-grow: 1; border: none; padding: 12px 15px; border-radius: 20px; font-size: 1em;" disabled>
                        <button style="background-color: #075E54; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 1.2em;"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>`;
                    break;
                default:
                    const isSent = type === 'sent-message';
                    wrapper.style.alignItems = isSent ? 'flex-end' : 'flex-start';
                    wrapper.innerHTML = `<div style="max-width: 80%; background-color: ${isSent ? '#dcf8c6' : '#fff'}; padding: 10px 15px; border-radius: 10px; ${isSent ? 'border-top-right-radius: 0;' : 'border-top-left-radius: 0;'} box-shadow: 0 1px 1px rgba(0,0,0,0.1); color: #333;">
                        ${element.dataset.text}
                        <span style="display: block; font-size: 0.7em; color: #999; text-align: right; margin-top: 5px;">${time}</span>
                    </div>`;
                    if (type === 'ask-question') {
                        const btnContainer = document.createElement('div');
                        btnContainer.style.cssText = "align-self: flex-start; display: flex; flex-wrap: wrap; gap: 10px; padding: 5px 0 10px 0;";
                        element.dataset.buttons.split(';').forEach(btnText => {
                            const button = document.createElement('button');
                            button.innerText = btnText;
                            button.style.cssText = "background-color: #fff; border: 1px solid #075E54; color: #075E54; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em;";
                            btnContainer.appendChild(button);
                        });
                        wrapper.appendChild(btnContainer);
                    }
            }
            return wrapper;
        }

        async function runFlowTest() {
            const testBtn = document.getElementById('test-flow-btn');
            testBtn.disabled = true;
            testBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Testando...`;

            const chatBody = document.getElementById('preview-chat-body');
            updatePreview(chatBody);
            chatBody.innerHTML = '';

            const delay = ms => new Promise(res => setTimeout(res, ms));

            const components = transformer.querySelectorAll('.canvas-component');
            for (const comp of components) {
                const type = comp.dataset.componentType;
                
                if (type === 'delay' || type === 'audio-message') {
                    const indicator = createPreviewComponent(comp);
                    chatBody.appendChild(indicator);
                    chatBody.scrollTop = chatBody.scrollHeight;
                    const delayTime = (type === 'delay' ? comp.dataset.delay : 1.5) * 1000;
                    await delay(delayTime);
                    indicator.remove();

                    if (type === 'audio-message') {
                        const audioPlayer = document.createElement('div');
                        audioPlayer.style.cssText = "display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 12px;";
                        audioPlayer.innerHTML = `<div class="audio-player-container">
                            <img src="${profilePicUrl}" onerror="this.src='https://placehold.co/40x40/777/FFFFFF?text=??'">
                            <button class="play-pause-btn"><i class="fas fa-play"></i></button>
                            <div class="progress-bar-container">
                                <div class="progress-bar"></div>
                            </div>
                            <div class="time-info">
                                <span class="current-time">0:00</span>
                                <span class="total-time" style="display:none;">0:00</span>
                                <span class="timestamp">${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <audio class="hidden-audio" src="${comp.dataset.url}"></audio>
                        </div>`;
                        chatBody.appendChild(audioPlayer);
                        setupAudioPlayer(audioPlayer);
                    }
                } else {
                    const previewElement = createPreviewComponent(comp);
                    if (previewElement) {
                        chatBody.appendChild(previewElement);
                        if(previewElement.querySelector('.audio-player-container')) {
                            setupAudioPlayer(previewElement);
                        }
                        chatBody.scrollTop = chatBody.scrollHeight;
                        await delay(500);
                    }
                }
            }
            
            testBtn.disabled = false;
            testBtn.innerHTML = `<i class="fas fa-play"></i> Testar Fluxo`;
        }

        function setupAudioPlayer(playerContainer) {
            const audio = playerContainer.querySelector('.hidden-audio');
            const playBtn = playerContainer.querySelector('.play-pause-btn i');
            const progressBar = playerContainer.querySelector('.progress-bar');
            const currentTimeEl = playerContainer.querySelector('.current-time');
            const totalTimeEl = playerContainer.querySelector('.total-time');

            const formatTime = (time) => {
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60).toString().padStart(2, '0');
                return `${minutes}:${seconds}`;
            }

            audio.addEventListener('loadedmetadata', () => {
                totalTimeEl.textContent = formatTime(audio.duration);
            });

            audio.addEventListener('timeupdate', () => {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${progress}%`;
                currentTimeEl.textContent = formatTime(audio.currentTime);
            });

            audio.addEventListener('ended', () => {
                playBtn.classList.remove('fa-pause');
                playBtn.classList.add('fa-play');
                progressBar.style.width = '0%';
            });

            playBtn.parentElement.addEventListener('click', () => {
                if (audio.paused) {
                    audio.play();
                    playBtn.classList.remove('fa-play');
                    playBtn.classList.add('fa-pause');
                } else {
                    audio.pause();
                    playBtn.classList.remove('fa-pause');
                    playBtn.classList.add('fa-play');
                }
            });
        }

        document.getElementById('test-flow-btn').addEventListener('click', runFlowTest);
        
        updatePreview();
    });
    </script>
</body>
</html>
